<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Neon Study Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Main stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Favicon (put your neon icon in static/favicon.png) -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body class="theme-dark">
    <div class="app-wrapper">
        <!-- Left: chat history sidebar -->
        <aside class="history-sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <button id="new-chat-btn">New chat</button>
            </div>
            <ul id="conversation-list"></ul>
        </aside>

        <!-- Right: main chat area -->
        <div class="main-area">
            <header class="app-header">
                <div class="logo-circle">
                    <span class="logo-text">AI</span>
                </div>
                <div class="header-text">
                    <h1>Neon Study Chatbot</h1>
                    <p id="current-chat-title">New chat</p>
                </div>
                <button id="theme-toggle" class="theme-toggle">Light mode</button>
            </header>

            <main class="chat-layout">
                <!-- Chat panel -->
                <section class="chat-panel">
                    <div id="chat-window"></div>

                    <!-- Typing indicator -->
                    <div id="typing-indicator" class="typing-indicator hidden">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>

                    <!-- Input form -->
                    <form id="chat-form">
                        <input
                            type="text"
                            id="user-input"
                            placeholder="Ask me anything about your homework..."
                            autocomplete="off"
                        >
                        <button type="submit">Send</button>
                    </form>
                </section>

                <!-- Right tips panel -->
                <aside class="side-panel">
                    <h2>Quick tips</h2>
                    <ul>
                        <li>Ask for explanations in clear steps.</li>
                        <li>Say "explain like 9th grade" for simpler answers.</li>
                        <li>Ask it to generate outlines, examples, or practice questions.</li>
                    </ul>
                    <div class="tag-list">
                        <span class="tag">Math</span>
                        <span class="tag">Science</span>
                        <span class="tag">English</span>
                        <span class="tag">History</span>
                    </div>
                </aside>
            </main>
        </div>
    </div>

    <script>
        const form = document.getElementById("chat-form");
        const userInput = document.getElementById("user-input");
        const chatWindow = document.getElementById("chat-window");
        const conversationList = document.getElementById("conversation-list");
        const newChatBtn = document.getElementById("new-chat-btn");
        const currentChatTitleEl = document.getElementById("current-chat-title");
        const typingIndicator = document.getElementById("typing-indicator");
        const themeToggleBtn = document.getElementById("theme-toggle");
        const bodyEl = document.body;

        const STORAGE_KEY_CONVOS = "ai_chatbot_conversations";
        const STORAGE_KEY_THEME = "ai_chatbot_theme";

        let conversations = [];
        let currentConversationId = null;

        // - Theme handling -
        function loadTheme() {
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME);
            if (savedTheme === "light") {
                bodyEl.classList.add("theme-light");
                bodyEl.classList.remove("theme-dark");
                themeToggleBtn.textContent = "Dark mode";
            } else {
                bodyEl.classList.add("theme-dark");
                bodyEl.classList.remove("theme-light");
                themeToggleBtn.textContent = "Light mode";
            }
        }

        function toggleTheme() {
            const isDark = bodyEl.classList.contains("theme-dark");
            if (isDark) {
                bodyEl.classList.remove("theme-dark");
                bodyEl.classList.add("theme-light");
                localStorage.setItem(STORAGE_KEY_THEME, "light");
                themeToggleBtn.textContent = "Dark mode";
            } else {
                bodyEl.classList.remove("theme-light");
                bodyEl.classList.add("theme-dark");
                localStorage.setItem(STORAGE_KEY_THEME, "dark");
                themeToggleBtn.textContent = "Light mode";
            }
        }

        themeToggleBtn.addEventListener("click", toggleTheme);

        // - Helpers for localStorage conversations -
        function loadConversations() {
            const saved = localStorage.getItem(STORAGE_KEY_CONVOS);
            if (saved) {
                conversations = JSON.parse(saved);
            } else {
                conversations = [];
            }

            if (conversations.length === 0) {
                const first = createNewConversation("New chat");
                conversations.push(first);
                currentConversationId = first.id;
                saveConversations();
            } else if (!currentConversationId) {
                currentConversationId = conversations[0].id;
            }
        }

        function saveConversations() {
            localStorage.setItem(STORAGE_KEY_CONVOS, JSON.stringify(conversations));
        }

        function createNewConversation(title) {
            return {
                id: Date.now().toString(),
                title: title || "New chat",
                messages: []
            };
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId);
        }

        // - UI rendering -
        function renderConversationList() {
            conversationList.innerHTML = "";
            conversations.forEach(conv => {
                const li = document.createElement("li");
                li.textContent = conv.title;
                li.classList.add("conversation-item");
                if (conv.id === currentConversationId) {
                    li.classList.add("active");
                }
                li.addEventListener("click", () => {
                    currentConversationId = conv.id;
                    renderConversationList();
                    renderChatWindow();
                });
                conversationList.appendChild(li);
            });

            const current = getCurrentConversation();
            if (current) {
                currentChatTitleEl.textContent = current.title;
            }
        }

        function renderChatWindow() {
            chatWindow.innerHTML = "";
            const current = getCurrentConversation();
            if (!current) return;
            current.messages.forEach(msg => {
                addMessage(msg.text, msg.sender, false);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addMessage(text, sender, save = true) {
            const bubble = document.createElement("div");
            bubble.classList.add("message-bubble", sender === "user" ? "user" : "bot");
            bubble.textContent = text;
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            if (save) {
                const conv = getCurrentConversation();
                if (!conv) return;
                conv.messages.push({
                    sender,
                    text,
                    time: new Date().toISOString()
                });

                // First user message becomes the title
                if (conv.title === "New chat" && sender === "user") {
                    conv.title = text.slice(0, 30) + (text.length > 30 ? "..." : "");
                }

                saveConversations();
                renderConversationList();
            }
        }

        function showTyping(show) {
            if (show) {
                typingIndicator.classList.remove("hidden");
            } else {
                typingIndicator.classList.add("hidden");
            }
        }

        // - Event handlers -
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, "user", true);
            userInput.value = "";
            userInput.focus();

            showTyping(true);

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message: text })
                });

                const data = await response.json();
                const reply = data.reply || "Something went wrong.";

                showTyping(false);
                addMessage(reply, "bot", true);

            } catch (err) {
                console.error(err);
                showTyping(false);
                addMessage("Error talking to the server.", "bot", true);
            }
        });

        newChatBtn.addEventListener("click", () => {
            const newConv = createNewConversation("New chat");
            conversations.unshift(newConv);
            currentConversationId = newConv.id;
            saveConversations();
            renderConversationList();
            renderChatWindow();
        });

        // - Init -
        loadTheme();
        loadConversations();
        renderConversationList();
        renderChatWindow();
    </script>
</body>
</html>