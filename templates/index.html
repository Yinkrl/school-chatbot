<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Neon Study Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Favicon (put favicon.png in /static) -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>

<body class="theme-dark">
    <div class="app-wrapper">

        <!-- Sidebar - chat history -->
        <aside class="history-sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <button id="new-chat-btn">New chat</button>
            </div>
            <ul id="conversation-list"></ul>
        </aside>

        <!-- Main section -->
        <div class="main-area">
            <header class="app-header">
                <div class="logo-circle">
                    <span class="logo-text">AI</span>
                </div>
                <div class="header-text">
                    <h1>Neon Study Chatbot</h1>
                    <p id="current-chat-title">New chat</p>
                </div>

                <button id="theme-toggle" class="theme-toggle">Light mode</button>
            </header>

            <main class="chat-layout">
                <!-- Chat panel -->
                <section class="chat-panel">
                    <div id="chat-window"></div>

                    <!-- Typing indicator -->
                    <div id="typing-indicator" class="typing-indicator hidden">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>

                    <!-- Input form -->
                    <form id="chat-form">
                        <input
                            id="user-input"
                            type="text"
                            placeholder="Ask me anything about your homework..."
                            autocomplete="off"
                        >
                        <button type="submit">Send</button>
                    </form>
                </section>

                <!-- Tips panel -->
                <aside class="side-panel">
                    <h2>Quick tips</h2>
                    <ul>
                        <li>Ask for step by step explanations.</li>
                        <li>Say "explain like 9th grade" for simpler answers.</li>
                        <li>Ask for outlines, examples, or practice questions.</li>
                    </ul>
                    <div class="tag-list">
                        <span class="tag">Math</span>
                        <span class="tag">Science</span>
                        <span class="tag">English</span>
                        <span class="tag">History</span>
                    </div>
                </aside>
            </main>
        </div>
    </div>

<script>
    // Selectors
    const form = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");
    const chatWindow = document.getElementById("chat-window");
    const conversationList = document.getElementById("conversation-list");
    const newChatBtn = document.getElementById("new-chat-btn");
    const typingIndicator = document.getElementById("typing-indicator");
    const currentChatTitleEl = document.getElementById("current-chat-title");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const bodyEl = document.body;

    const STORAGE_KEY_CONVOS = "ai_chatbot_conversations";
    const STORAGE_KEY_THEME = "ai_chatbot_theme";

    let conversations = [];
    let currentConversationId = null;

    // Theme handling
    function loadTheme() {
        const saved = localStorage.getItem(STORAGE_KEY_THEME);
        if (saved === "light") {
            bodyEl.classList.remove("theme-dark");
            bodyEl.classList.add("theme-light");
            themeToggleBtn.textContent = "Dark mode";
        } else {
            bodyEl.classList.remove("theme-light");
            bodyEl.classList.add("theme-dark");
            themeToggleBtn.textContent = "Light mode";
        }
    }

    function toggleTheme() {
        const isDark = bodyEl.classList.contains("theme-dark");
        if (isDark) {
            bodyEl.classList.remove("theme-dark");
            bodyEl.classList.add("theme-light");
            localStorage.setItem(STORAGE_KEY_THEME, "light");
            themeToggleBtn.textContent = "Dark mode";
        } else {
            bodyEl.classList.remove("theme-light");
            bodyEl.classList.add("theme-dark");
            localStorage.setItem(STORAGE_KEY_THEME, "dark");
            themeToggleBtn.textContent = "Light mode";
        }
    }

    themeToggleBtn.addEventListener("click", toggleTheme);

    // ChatGPT style message formatting
    function formatMessageText(text) {
        const escaped = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        const paragraphs = escaped.split(/\n\s*\n/);

        return paragraphs
            .map(p => `<p>${p.replace(/\n/g, "<br>")}</p>`)
            .join("");
    }

    // Conversations storage
    function loadConversations() {
        const saved = localStorage.getItem(STORAGE_KEY_CONVOS);
        conversations = saved ? JSON.parse(saved) : [];

        if (conversations.length === 0) {
            const first = createNewConversation();
            conversations.push(first);
            currentConversationId = first.id;
            saveConversations();
        } else {
            currentConversationId = conversations[0].id;
        }
    }

    function saveConversations() {
        localStorage.setItem(STORAGE_KEY_CONVOS, JSON.stringify(conversations));
    }

    function createNewConversation() {
        return {
            id: Date.now().toString(),
            title: "New chat",
            messages: []
        };
    }

    function getCurrentConversation() {
        return conversations.find(c => c.id === currentConversationId);
    }

    function deleteConversation(id) {
        conversations = conversations.filter(c => c.id !== id);

        if (conversations.length === 0) {
            const fresh = createNewConversation();
            conversations.push(fresh);
            currentConversationId = fresh.id;
        } else if (currentConversationId === id) {
            currentConversationId = conversations[0].id;
        }

        saveConversations();
        renderConversationList();
        renderChatWindow();
    }

    // Sidebar rendering
    function renderConversationList() {
        conversationList.innerHTML = "";
        conversations.forEach(conv => {
            const li = document.createElement("li");
            li.classList.add("conversation-item");
            if (conv.id === currentConversationId) li.classList.add("active");

            const titleSpan = document.createElement("span");
            titleSpan.classList.add("conversation-title");
            titleSpan.textContent = conv.title;

            const deleteBtn = document.createElement("button");
            deleteBtn.classList.add("conversation-delete");
            deleteBtn.textContent = "Ã—";

            titleSpan.addEventListener("click", () => {
                currentConversationId = conv.id;
                renderConversationList();
                renderChatWindow();
            });

            deleteBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                deleteConversation(conv.id);
            });

            li.appendChild(titleSpan);
            li.appendChild(deleteBtn);
            conversationList.appendChild(li);
        });

        const current = getCurrentConversation();
        if (current) {
            currentChatTitleEl.textContent = current.title;
        }
    }

    // Chat window rendering
    function renderChatWindow() {
        chatWindow.innerHTML = "";
        const conv = getCurrentConversation();
        if (!conv) return;
        conv.messages.forEach(msg => addMessage(msg.text, msg.sender, false));
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function addMessage(text, sender, save = true) {
        const bubble = document.createElement("div");
        bubble.classList.add("message-bubble", sender === "user" ? "user" : "bot");

        bubble.innerHTML = formatMessageText(text);
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        if (save) {
            const conv = getCurrentConversation();
            if (!conv) return;

            conv.messages.push({
                sender,
                text,
                time: new Date().toISOString()
            });

            if (conv.title === "New chat" && sender === "user") {
                conv.title = text.slice(0, 30) + (text.length > 30 ? "..." : "");
            }

            saveConversations();
            renderConversationList();
        }
    }

    // Typing indicator
    function showTyping(show) {
        if (show) {
            typingIndicator.classList.remove("hidden");
        } else {
            typingIndicator.classList.add("hidden");
        }
    }

    // Sending messages
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, "user", true);
        userInput.value = "";
        userInput.focus();

        showTyping(true);

        try {
            const response = await fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();
            const reply = data.reply || "Something went wrong.";

            showTyping(false);
            addMessage(reply, "bot", true);
        } catch (err) {
            console.error(err);
            showTyping(false);
            addMessage("Error talking to the server.", "bot", true);
        }
    });

    // New chat button
    newChatBtn.addEventListener("click", () => {
        const fresh = createNewConversation();
        conversations.unshift(fresh);
        currentConversationId = fresh.id;
        saveConversations();
        renderConversationList();
        renderChatWindow();
    });

    // Init
    loadTheme();
    loadConversations();
    renderConversationList();
    renderChatWindow();
</script>
</body>
</html>