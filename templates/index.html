<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Neon Study Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>

<body class="theme-dark">
    <div class="app-wrapper">

        <!-- Sidebar -->
        <aside class="history-sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <button id="new-chat-btn">New chat</button>
            </div>
            <ul id="conversation-list"></ul>
        </aside>

        <!-- Main section -->
        <div class="main-area">
            <header class="app-header">
                <div class="logo-circle">
                    <span class="logo-text">AI</span>
                </div>
                <div class="header-text">
                    <h1>Neon Study Chatbot</h1>
                    <p id="current-chat-title">New chat</p>
                </div>

                <button id="theme-toggle" class="theme-toggle">Light mode</button>
            </header>

            <main class="chat-layout">
                <section class="chat-panel">
                    <div id="chat-window"></div>

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="typing-indicator hidden">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>

                    <form id="chat-form">
                        <input id="user-input" type="text" placeholder="Ask me anything…" autocomplete="off">
                        <button type="submit">Send</button>
                    </form>
                </section>

                <aside class="side-panel">
                    <h2>Quick Tips</h2>
                    <ul>
                        <li>Ask for step-by-step explanations</li>
                        <li>Say "explain like 9th grade"</li>
                        <li>Ask for examples + outlines</li>
                    </ul>
                    <div class="tag-list">
                        <span class="tag">Math</span>
                        <span class="tag">Science</span>
                        <span class="tag">History</span>
                        <span class="tag">English</span>
                    </div>
                </aside>
            </main>
        </div>
    </div>

<script>
/* ---------------------------
    SELECTORS + CONSTANTS
------------------------------*/
const form = document.getElementById("chat-form");
const userInput = document.getElementById("user-input");
const chatWindow = document.getElementById("chat-window");
const conversationList = document.getElementById("conversation-list");
const newChatBtn = document.getElementById("new-chat-btn");
const typingIndicator = document.getElementById("typing-indicator");
const currentChatTitleEl = document.getElementById("current-chat-title");
const themeToggleBtn = document.getElementById("theme-toggle");
const bodyEl = document.body;

const STORAGE_KEY_CONVOS = "ai_chatbot_conversations";
const STORAGE_KEY_THEME = "ai_chatbot_theme";

let conversations = [];
let currentConversationId = null;

/* ---------------------------
      THEME HANDLING
------------------------------*/
function loadTheme() {
    const saved = localStorage.getItem(STORAGE_KEY_THEME);
    if (saved === "light") {
        bodyEl.classList.replace("theme-dark", "theme-light");
        themeToggleBtn.textContent = "Dark mode";
    } else {
        bodyEl.classList.replace("theme-light", "theme-dark");
        themeToggleBtn.textContent = "Light mode";
    }
}

themeToggleBtn.addEventListener("click", () => {
    if (bodyEl.classList.contains("theme-dark")) {
        bodyEl.classList.replace("theme-dark", "theme-light");
        localStorage.setItem(STORAGE_KEY_THEME, "light");
        themeToggleBtn.textContent = "Dark mode";
    } else {
        bodyEl.classList.replace("theme-light", "theme-dark");
        localStorage.setItem(STORAGE_KEY_THEME, "dark");
        themeToggleBtn.textContent = "Light mode";
    }
});

/* ---------------------------
   CHAT FORMATTING (CHATGPT-LIKE)
------------------------------*/
function formatMessageText(text) {
    const escaped = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

    const paragraphs = escaped.split(/\n\s*\n/);

    return paragraphs
        .map(p => `<p>${p.replace(/\n/g, "<br>")}</p>`)
        .join("");
}

/* ---------------------------
    CONVERSATION STORAGE
------------------------------*/
function loadConversations() {
    const saved = localStorage.getItem(STORAGE_KEY_CONVOS);
    conversations = saved ? JSON.parse(saved) : [];

    if (conversations.length === 0) {
        const first = createNewConversation();
        conversations.push(first);
        currentConversationId = first.id;
        saveConversations();
    } else {
        currentConversationId = conversations[0].id;
    }
}

function saveConversations() {
    localStorage.setItem(STORAGE_KEY_CONVOS, JSON.stringify(conversations));
}

function createNewConversation() {
    return { id: Date.now().toString(), title: "New chat", messages: [] };
}

function deleteConversation(id) {
    conversations = conversations.filter(c => c.id !== id);

    if (conversations.length === 0) {
        const fresh = createNewConversation();
        conversations.push(fresh);
        currentConversationId = fresh.id;
    } else if (currentConversationId === id) {
        currentConversationId = conversations[0].id;
    }

    saveConversations();
    renderConversationList();
    renderChatWindow();
}

function getCurrentConversation() {
    return conversations.find(c => c.id === currentConversationId);
}

/* ---------------------------
       RENDER SIDEBAR
------------------------------*/
function renderConversationList() {
    conversationList.innerHTML = "";
    
    conversations.forEach(conv => {
        const li = document.createElement("li");
        li.classList.add("conversation-item");
        if (conv.id === currentConversationId) li.classList.add("active");

        const title = document.createElement("span");
        title.classList.add("conversation-title");
        title.textContent = conv.title;

        const delBtn = document.createElement("button");
        delBtn.classList.add("conversation-delete");
        delBtn.textContent = "×";

        title.addEventListener("click", () => {
            currentConversationId = conv.id;
            renderConversationList();
            renderChatWindow();
        });

        delBtn.addEventListener("click", e => {
            e.stopPropagation();
            deleteConversation(conv.id);
        });

        li.appendChild(title);
        li.appendChild(delBtn);
        conversationList.appendChild(li);
    });

    currentChatTitleEl.textContent = getCurrentConversation().title;
}

/* ---------------------------
         RENDER CHAT
------------------------------*/
function renderChatWindow() {
    chatWindow.innerHTML = "";
    const conv = getCurrentConversation();
    conv.messages.forEach(msg => addMessage(msg.text, msg.sender, false));
}

/* ---------------------------
        ADD MESSAGE
------------------------------*/
function addMessage(text, sender, save = true) {
    const bubble = document.createElement("div");
    bubble.classList.add("message-bubble", sender);

    bubble.innerHTML = formatMessageText(text);
    chatWindow.appendChild(bubble);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    if (save) {
        const conv = getCurrentConversation();
        conv.messages.push({ sender, text });

        if (conv.title === "New chat" && sender === "user") {
            conv.title = text.slice(0, 25) + (text.length > 25 ? "..." : "");
        }

        saveConversations();
        renderConversationList();
    }
}

/* ---------------------------
        TYPING DOTS
------------------------------*/
function showTyping(state) {
    typingIndicator.classList.toggle("hidden", !state);
}

/* ---------------------------
       MESSAGE SEND EVENT
------------------------------*/
form.addEventListener("submit", async e => {
    e.preventDefault();
    
    const text = userInput.value.trim();
    if (!text) return;

    addMessage(text, "user");
    userInput.value = "";

    showTyping(true);

    const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    });

    const data = await response.json();
    showTyping(false);
    addMessage(data.reply, "bot");
});

/* ---------------------------
            NEW CHAT
------------------------------*/
newChatBtn.addEventListener("click", () => {
    const fresh = createNewConversation();
    conversations.unshift(fresh);
    currentConversationId = fresh.id;
    saveConversations();
    renderConversationList();
    renderChatWindow();
});

/* ---------------------------
            INIT
------------------------------*/
loadTheme();
loadConversations();
renderConversationList();
renderChatWindow();

</script>
</body>
</html>