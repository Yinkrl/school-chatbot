<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Study Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Main stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Favicon (optional - needs static/favicon.png or .ico) -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>
    <div class="app-wrapper">
        <!-- Left: chat history sidebar -->
        <aside class="history-sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <button id="new-chat-btn">New chat</button>
            </div>
            <ul id="conversation-list"></ul>
        </aside>

        <!-- Right: main chat area -->
        <div class="main-area">
            <header class="app-header">
                <div class="logo-circle">AI</div>
                <div class="header-text">
                    <h1>AI Study Chatbot</h1>
                    <p id="current-chat-title">New chat</p>
                </div>
            </header>

            <main class="chat-layout">
                <!-- Chat panel -->
                <section class="chat-panel">
                    <div id="chat-window"></div>

                    <form id="chat-form">
                        <input
                            type="text"
                            id="user-input"
                            placeholder="Ask me anything about your homework..."
                            autocomplete="off"
                        >
                        <button type="submit">Send</button>
                    </form>
                </section>

                <!-- Right tips panel -->
                <aside class="side-panel">
                    <h2>Quick tips</h2>
                    <ul>
                        <li>Ask for explanations in simple steps.</li>
                        <li>Say "explain like 9th grade" for simpler answers.</li>
                        <li>Ask it to generate outlines, examples, or practice questions.</li>
                    </ul>
                    <div class="tag-list">
                        <span class="tag">Math</span>
                        <span class="tag">Science</span>
                        <span class="tag">English</span>
                        <span class="tag">History</span>
                    </div>
                </aside>
            </main>
        </div>
    </div>

    <script>
        const form = document.getElementById("chat-form");
        const userInput = document.getElementById("user-input");
        const chatWindow = document.getElementById("chat-window");
        const conversationList = document.getElementById("conversation-list");
        const newChatBtn = document.getElementById("new-chat-btn");
        const currentChatTitleEl = document.getElementById("current-chat-title");

        const STORAGE_KEY = "ai_chatbot_conversations";

        let conversations = [];
        let currentConversationId = null;

        // Load from localStorage
        function loadConversations() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                conversations = JSON.parse(saved);
            } else {
                conversations = [];
            }

            if (conversations.length === 0) {
                const first = createNewConversation("New chat");
                conversations.push(first);
                currentConversationId = first.id;
                saveConversations();
            } else if (!currentConversationId) {
                currentConversationId = conversations[0].id;
            }
        }

        function saveConversations() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
        }

        function createNewConversation(title) {
            return {
                id: Date.now().toString(),
                title: title || "New chat",
                messages: []
            };
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId);
        }

        // Render the sidebar list
        function renderConversationList() {
            conversationList.innerHTML = "";
            conversations.forEach(conv => {
                const li = document.createElement("li");
                li.textContent = conv.title;
                li.classList.add("conversation-item");
                if (conv.id === currentConversationId) {
                    li.classList.add("active");
                }
                li.addEventListener("click", () => {
                    currentConversationId = conv.id;
                    renderConversationList();
                    renderChatWindow();
                });
                conversationList.appendChild(li);
            });

            const current = getCurrentConversation();
            if (current) {
                currentChatTitleEl.textContent = current.title;
            }
        }

        // Render all messages in the current chat
        function renderChatWindow() {
            chatWindow.innerHTML = "";
            const current = getCurrentConversation();
            if (!current) return;
            current.messages.forEach(msg => {
                addMessage(msg.text, msg.sender, false);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Add one message bubble to the UI (+ optional save)
        function addMessage(text, sender, save = true) {
            const bubble = document.createElement("div");
            bubble.classList.add("message-bubble", sender === "user" ? "user" : "bot");
            bubble.textContent = text;
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            if (save) {
                const conv = getCurrentConversation();
                if (!conv) return;
                conv.messages.push({
                    sender,
                    text,
                    time: new Date().toISOString()
                });

                // First user message becomes the title
                if (conv.title === "New chat" && sender === "user") {
                    conv.title = text.slice(0, 30) + (text.length > 30 ? "..." : "");
                }

                saveConversations();
                renderConversationList();
            }
        }

        // Handle sending messages
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, "user", true);
            userInput.value = "";
            userInput.focus();

            addMessage("Thinking...", "bot", false);
            const thinkingBubble = chatWindow.lastChild;

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message: text })
                });

                const data = await response.json();
                const reply = data.reply || "Something went wrong.";

                // Update bubble text
                thinkingBubble.textContent = reply;

                // Save bot reply
                const conv = getCurrentConversation();
                if (conv) {
                    conv.messages.push({
                        sender: "bot",
                        text: reply,
                        time: new Date().toISOString()
                    });
                    saveConversations();
                }
            } catch (err) {
                console.error(err);
                thinkingBubble.textContent = "Error talking to the server.";
            }
        });

        // New chat button
        newChatBtn.addEventListener("click", () => {
            const newConv = createNewConversation("New chat");
            conversations.unshift(newConv);
            currentConversationId = newConv.id;
            saveConversations();
            renderConversationList();
            renderChatWindow();
        });

        // Initialize
        loadConversations();
        renderConversationList();
        renderChatWindow();
    </script>
</body>
</html>